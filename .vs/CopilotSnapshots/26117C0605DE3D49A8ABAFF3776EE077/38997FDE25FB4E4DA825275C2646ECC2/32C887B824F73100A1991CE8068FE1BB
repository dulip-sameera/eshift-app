using eshift.Dto;
using eshift.Model;
using eshift.Dao;
using eshift.Dao.Impl;
using eshift.Utils.Mapper;
using eshift.Enums;
using eshift.Utils.Generator;
using System.Collections.Generic;
using System;

namespace eshift.Service.Impl
{
    internal class JobServiceImpl : IJobService
    {
        private readonly IJobDao jobDao = new JobDaoImpl();
        private readonly ICustomerDao customerDao = new CustomerDaoImpl();
        private readonly ITransportUnitDao transportUnitDao = new TransportUnitDaoImpl();
        private readonly IVehicleDao vehicleDao = new VehicleDaoImpl();

        public List<JobGridDto>? GetAllJobsForGrid()
        {
            var jobTuples = jobDao.GetAllJobsWithCustomerAndStatus();
            if (jobTuples == null || jobTuples.Count == 0)
                throw new KeyNotFoundException("No jobs found.");

            var gridDtos = new List<JobGridDto>();
            foreach (var tuple in jobTuples)
            {
                var jobModel = tuple.Item1;
                var customerCusId = tuple.Item2;
                var customerFirstName = tuple.Item3;
                var statusName = tuple.Item4;
                gridDtos.Add(JobMapper.ToGridDto(jobModel, customerCusId, customerFirstName, statusName));
            }
            return gridDtos;
        }

        public void DeleteJobByJobId(string jobId, JobStatusEnum status)
        {
            if (string.IsNullOrWhiteSpace(jobId))
                throw new ArgumentException("Job ID cannot be empty.");

            var tuple = jobDao.GetJobWithCustomerAndStatusByJobId(jobId);
            if (tuple == null)
                throw new KeyNotFoundException("Job not found for deletion.");

            bool updated = jobDao.UpdateJobStatusByJobId(jobId, (int)status);
            if (!updated)
                throw new Exception("Failed to delete (soft delete) job.");
        }

        public void UpdateJob(string jobId, JobDto job)
        {
            if (string.IsNullOrWhiteSpace(jobId))
                throw new ArgumentException("Job ID cannot be empty.");

            var tuple = jobDao.GetJobWithCustomerAndStatusByJobId(jobId);
            if (tuple == null)
                throw new KeyNotFoundException("Job not found for update.");

            var model = JobMapper.ToModel(job);
            bool updated = jobDao.UpdateJob(jobId, model);
            if (!updated)
                throw new Exception("Failed to update job.");
        }

        public JobGridDto? GetJobForGridByJobId(string jobId)
        {
            var tuple = jobDao.GetJobWithCustomerAndStatusByJobId(jobId);
            if (tuple == null) return null;
            var jobModel = tuple.Value.Item1;
            var customerCusId = tuple.Value.Item2;
            var customerFirstName = tuple.Value.Item3;
            var statusName = tuple.Value.Item4;
            return JobMapper.ToGridDto(jobModel, customerCusId, customerFirstName, statusName);
        }

        public CustomerDto? GetCustomerById(string customerId)
        {
            var customerModel = customerDao.GetCustomerByCusId(customerId);
            return customerModel != null ? CustomerMapper.ToDto(customerModel) : null;
        }

        public TransportUnitDto? GetTransportUnitById(string tuId)
        {
            var tuModel = transportUnitDao.GetTransportUnitByTuId(tuId);
            return tuModel != null ? TransportUnitMapper.ToDto(tuModel) : null;
        }

        public void CreateJob(CreateJobFormDto dto)
        {
            // Generate job id
            string jobId = JobIdGenerator.GenerateNextJobId();
            int statusId = dto.TransportUnits.Count > 0 ? (int)JobStatusEnum.IN_PROGRESS : (int)JobStatusEnum.ACCEPTED;
            // Generate load ids
            foreach (var load in dto.Loads)
                load.LoadId = LoadIdGenerator.GenerateNextLoadId();
            jobDao.CreateJob(jobId, dto, statusId);
        }
    }
}